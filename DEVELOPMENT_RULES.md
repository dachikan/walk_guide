# Walk Guide 開発ルール

## 📋 プログラム修正時の必須確認事項

### ✅ 遵守事項

#### 1. 3状態システムの厳守
- **通常状態** (`AppState.normal`)
- **コマンド待機中** (`AppState.listening`)  
- **AI分析・音声出力中** (`AppState.processing`)

**この3つの状態だけを維持すること**

#### 2. エラー時の状態管理
- エラーが発生した場合でも、必ず**3つの状態のいずれか**に修飾させること
- エラー復旧後は適切な状態（通常は`AppState.normal`）に戻すこと

#### 3. 状態遷移の明確化
- 状態変更は`setState()`で確実に実行すること
- 状態変更のタイミングを明確にすること
- 非同期処理と状態管理を適切に同期させること

### 🚫 禁止事項

#### 1. 追加状態の作成禁止
- **第4の状態**を作成することは**絶対禁止**
- 例：`AppState.error`、`AppState.waiting`、`AppState.recovery`等
- 「エラー復帰待ち中」などの独立した状態を作らないこと

#### 2. 中途半端な状態の放置禁止
- 状態表示と実際の動作が一致しない状況を作らないこと
- 「音声待機中」なのに実際は音声認識していない状態は禁止

#### 3. 複雑な状態管理の実装禁止
- 過度に複雑な状態チェックや条件分岐を避けること
- シンプルで理解しやすい実装を優先すること

## 🔄 状態遷移パターン

### 正常な状態遷移
```
normal → listening → processing → normal
```

### エラー発生時の対応
```
listening → エラー発生 → normal (即座に復帰)
processing → エラー発生 → normal (即座に復帰)
```

## 🎯 実装時のチェックリスト

修正前に以下を必ず確認：

- [ ] 3状態システムを維持しているか？
- [ ] 新しい状態を作成していないか？
- [ ] エラー時に適切な状態に戻るか？
- [ ] 状態表示と実際の動作が一致するか？
- [ ] シンプルな実装になっているか？

## 📝 修正履歴での失敗例

### ❌ v0.0.1+2 の失敗
- タイマーによる自動状態変更を追加
- 複雑な検証処理を実装
- 結果：「音声認識でエラーが発生しました」連発

### ❌ v0.0.1+4 の失敗
- 音声認識成功後に状態変更する複雑な仕組み
- 過度なエラーハンドリング
- 結果：「どうぞ」と言うのにマイクが青のまま

### ✅ v0.0.1+5 の修正
- シンプルな3状態システムに回帰
- 基本的な動作パターンを維持
- 結果：安定した動作

## 👥 将来の開発者へのメッセージ

**「複雑な修正は失敗の元」**

このアプリは視覚障害者向けの重要なツールです。安定性と予測可能性が最優先です。

- 機能追加時も3状態システムを維持してください
- エラー処理は複雑にせず、常に3つの状態のいずれかに戻してください  
- 「改善」のつもりの修正が改悪になることを常に意識してください

## 📊 状態管理の実装参考

```dart
enum AppState {
  normal,           // 通常状態（解析中）
  listening,        // 音声コマンド待ち
  processing,       // コマンド処理中
}

// ✅ 正しい実装例
void _returnToNormal() {
  setState(() {
    _currentState = AppState.normal;
  });
}

// ❌ 禁止例 - 第4の状態
enum AppState {
  normal,
  listening,
  processing,
  error,     // この追加は禁止！
}
```

---

**このルールを守ることで、安定した視覚障害者向けアプリを維持できます。**